diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/Kconfig src/nuttx/configs/Kconfig
--- tmp/nuttx/configs/Kconfig	2015-06-10 21:03:49.805512468 +0300
+++ src/nuttx/configs/Kconfig	2015-07-01 22:13:52.006529848 +0300
@@ -785,7 +785,7 @@ config ARCH_BOARD_SKP16C26
 
 config ARCH_BOARD_SPARK
 	bool "Spark Core"
-	depends on ARCH_CHIP_STM32F103CB
+	depends on ARCH_CHIP_STM32F103CB || ARCH_CHIP_STM32F103RC
 	select ARCH_HAVE_LEDS
 	select ARCH_HAVE_BUTTONS
 	select ARCH_HAVE_IRQBUTTONS
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/spark/nsh/defconfig src/nuttx/configs/spark/nsh/defconfig
--- tmp/nuttx/configs/spark/nsh/defconfig	2015-06-10 21:03:49.133512463 +0300
+++ src/nuttx/configs/spark/nsh/defconfig	2015-07-26 22:23:54.427364376 +0300
@@ -16,7 +16,7 @@ CONFIG_HOST_LINUX=y
 #
 # Build Configuration
 #
-# CONFIG_APPS_DIR="../apps"
+CONFIG_APPS_DIR="../apps"
 CONFIG_BUILD_FLAT=y
 # CONFIG_BUILD_2PASS is not set
 
@@ -41,11 +41,39 @@ CONFIG_RAW_BINARY=y
 #
 # Debug Options
 #
-# CONFIG_DEBUG is not set
+CONFIG_DEBUG=y
 CONFIG_ARCH_HAVE_HEAPCHECK=y
+# CONFIG_DEBUG_VERBOSE is not set
+
+#
+# Subsystem Debug Options
+#
+# CONFIG_DEBUG_AUDIO is not set
+# CONFIG_DEBUG_BINFMT is not set
+# CONFIG_DEBUG_FS is not set
+# CONFIG_DEBUG_GRAPHICS is not set
+# CONFIG_DEBUG_LIB is not set
+# CONFIG_DEBUG_MM is not set
+# CONFIG_DEBUG_SCHED is not set
+
+#
+# OS Function Debug Options
+#
+# CONFIG_DEBUG_DMA is not set
+# CONFIG_DEBUG_HEAP is not set
+# CONFIG_DEBUG_IRQ is not set
+
+#
+# Driver Debug Options
+#
+# CONFIG_DEBUG_LEDS is not set
+# CONFIG_DEBUG_ANALOG is not set
+# CONFIG_DEBUG_GPIO is not set
+# CONFIG_DEBUG_SPI is not set
+# CONFIG_DEBUG_USB is not set
 CONFIG_ARCH_HAVE_STACKCHECK=y
 # CONFIG_STACK_COLORATION is not set
-# CONFIG_DEBUG_SYMBOLS is not set
+CONFIG_DEBUG_SYMBOLS=y
 CONFIG_ARCH_HAVE_CUSTOMOPT=y
 # CONFIG_DEBUG_NOOPT is not set
 # CONFIG_DEBUG_CUSTOMOPT is not set
@@ -79,6 +107,7 @@ CONFIG_ARCH="arm"
 # CONFIG_ARCH_CHIP_KL is not set
 # CONFIG_ARCH_CHIP_LM is not set
 # CONFIG_ARCH_CHIP_TIVA is not set
+# CONFIG_ARCH_CHIP_LPC11XX is not set
 # CONFIG_ARCH_CHIP_LPC17XX is not set
 # CONFIG_ARCH_CHIP_LPC214X is not set
 # CONFIG_ARCH_CHIP_LPC2378 is not set
@@ -87,7 +116,9 @@ CONFIG_ARCH="arm"
 # CONFIG_ARCH_CHIP_NUC1XX is not set
 # CONFIG_ARCH_CHIP_SAMA5 is not set
 # CONFIG_ARCH_CHIP_SAMD is not set
+# CONFIG_ARCH_CHIP_SAML is not set
 # CONFIG_ARCH_CHIP_SAM34 is not set
+# CONFIG_ARCH_CHIP_SAMV7 is not set
 CONFIG_ARCH_CHIP_STM32=y
 # CONFIG_ARCH_CHIP_STR71X is not set
 # CONFIG_ARCH_ARM7TDMI is not set
@@ -96,6 +127,7 @@ CONFIG_ARCH_CHIP_STM32=y
 # CONFIG_ARCH_CORTEXM0 is not set
 CONFIG_ARCH_CORTEXM3=y
 # CONFIG_ARCH_CORTEXM4 is not set
+# CONFIG_ARCH_CORTEXM7 is not set
 # CONFIG_ARCH_CORTEXA5 is not set
 # CONFIG_ARCH_CORTEXA8 is not set
 CONFIG_ARCH_FAMILY="armv7-m"
@@ -103,18 +135,27 @@ CONFIG_ARCH_CHIP="stm32"
 # CONFIG_ARMV7M_USEBASEPRI is not set
 CONFIG_ARCH_HAVE_CMNVECTOR=y
 # CONFIG_ARMV7M_CMNVECTOR is not set
+# CONFIG_ARMV7M_LAZYFPU is not set
 # CONFIG_ARCH_HAVE_FPU is not set
+# CONFIG_ARCH_HAVE_DPFPU is not set
 # CONFIG_ARMV7M_MPU is not set
+# CONFIG_DEBUG_HARDFAULT is not set
 
 #
 # ARMV7M Configuration Options
 #
+# CONFIG_ARMV7M_HAVE_ICACHE is not set
+# CONFIG_ARMV7M_HAVE_DCACHE is not set
+# CONFIG_ARMV7M_HAVE_ITCM is not set
+# CONFIG_ARMV7M_HAVE_DTCM is not set
 # CONFIG_ARMV7M_TOOLCHAIN_BUILDROOT is not set
 # CONFIG_ARMV7M_TOOLCHAIN_CODEREDL is not set
 CONFIG_ARMV7M_TOOLCHAIN_CODESOURCERYL=y
 # CONFIG_ARMV7M_TOOLCHAIN_GNU_EABIL is not set
+CONFIG_ARMV7M_HAVE_STACKCHECK=y
 # CONFIG_ARMV7M_STACKCHECK is not set
 # CONFIG_ARMV7M_ITMSYSLOG is not set
+# CONFIG_SERIAL_TERMIOS is not set
 
 #
 # STM32 Configuration Options
@@ -138,6 +179,7 @@ CONFIG_ARMV7M_TOOLCHAIN_CODESOURCERYL=y
 # CONFIG_ARCH_CHIP_STM32L152V8 is not set
 # CONFIG_ARCH_CHIP_STM32L152VB is not set
 # CONFIG_ARCH_CHIP_STM32L162ZD is not set
+# CONFIG_ARCH_CHIP_STM32L162VE is not set
 # CONFIG_ARCH_CHIP_STM32F100C8 is not set
 # CONFIG_ARCH_CHIP_STM32F100CB is not set
 # CONFIG_ARCH_CHIP_STM32F100R8 is not set
@@ -155,10 +197,10 @@ CONFIG_ARMV7M_TOOLCHAIN_CODESOURCERYL=y
 # CONFIG_ARCH_CHIP_STM32F103TB is not set
 # CONFIG_ARCH_CHIP_STM32F103C4 is not set
 # CONFIG_ARCH_CHIP_STM32F103C8 is not set
-CONFIG_ARCH_CHIP_STM32F103CB=y
+# CONFIG_ARCH_CHIP_STM32F103CB is not set
 # CONFIG_ARCH_CHIP_STM32F103R8 is not set
 # CONFIG_ARCH_CHIP_STM32F103RB is not set
-# CONFIG_ARCH_CHIP_STM32F103RC is not set
+CONFIG_ARCH_CHIP_STM32F103RC=y
 # CONFIG_ARCH_CHIP_STM32F103RD is not set
 # CONFIG_ARCH_CHIP_STM32F103RE is not set
 # CONFIG_ARCH_CHIP_STM32F103RG is not set
@@ -169,8 +211,11 @@ CONFIG_ARCH_CHIP_STM32F103CB=y
 # CONFIG_ARCH_CHIP_STM32F103ZE is not set
 # CONFIG_ARCH_CHIP_STM32F105VB is not set
 # CONFIG_ARCH_CHIP_STM32F107VC is not set
+# CONFIG_ARCH_CHIP_STM32F205RG is not set
 # CONFIG_ARCH_CHIP_STM32F207IG is not set
 # CONFIG_ARCH_CHIP_STM32F207ZE is not set
+# CONFIG_ARCH_CHIP_STM32F302K6 is not set
+# CONFIG_ARCH_CHIP_STM32F302K8 is not set
 # CONFIG_ARCH_CHIP_STM32F302CB is not set
 # CONFIG_ARCH_CHIP_STM32F302CC is not set
 # CONFIG_ARCH_CHIP_STM32F302RB is not set
@@ -183,6 +228,24 @@ CONFIG_ARCH_CHIP_STM32F103CB=y
 # CONFIG_ARCH_CHIP_STM32F303RC is not set
 # CONFIG_ARCH_CHIP_STM32F303VB is not set
 # CONFIG_ARCH_CHIP_STM32F303VC is not set
+# CONFIG_ARCH_CHIP_STM32F372C8 is not set
+# CONFIG_ARCH_CHIP_STM32F372R8 is not set
+# CONFIG_ARCH_CHIP_STM32F372V8 is not set
+# CONFIG_ARCH_CHIP_STM32F372CB is not set
+# CONFIG_ARCH_CHIP_STM32F372RB is not set
+# CONFIG_ARCH_CHIP_STM32F372VB is not set
+# CONFIG_ARCH_CHIP_STM32F372CC is not set
+# CONFIG_ARCH_CHIP_STM32F372RC is not set
+# CONFIG_ARCH_CHIP_STM32F372VC is not set
+# CONFIG_ARCH_CHIP_STM32F373C8 is not set
+# CONFIG_ARCH_CHIP_STM32F373R8 is not set
+# CONFIG_ARCH_CHIP_STM32F373V8 is not set
+# CONFIG_ARCH_CHIP_STM32F373CB is not set
+# CONFIG_ARCH_CHIP_STM32F373RB is not set
+# CONFIG_ARCH_CHIP_STM32F373VB is not set
+# CONFIG_ARCH_CHIP_STM32F373CC is not set
+# CONFIG_ARCH_CHIP_STM32F373RC is not set
+# CONFIG_ARCH_CHIP_STM32F373VC is not set
 # CONFIG_ARCH_CHIP_STM32F401RE is not set
 # CONFIG_ARCH_CHIP_STM32F411RE is not set
 # CONFIG_ARCH_CHIP_STM32F405RG is not set
@@ -209,12 +272,14 @@ CONFIG_STM32_STM32F10XX=y
 # CONFIG_STM32_CONNECTIVITYLINE is not set
 CONFIG_STM32_PERFORMANCELINE=y
 # CONFIG_STM32_USBACCESSLINE is not set
-# CONFIG_STM32_HIGHDENSITY is not set
-CONFIG_STM32_MEDIUMDENSITY=y
+CONFIG_STM32_HIGHDENSITY=y
+# CONFIG_STM32_MEDIUMDENSITY is not set
 # CONFIG_STM32_LOWDENSITY is not set
 # CONFIG_STM32_STM32F20XX is not set
+# CONFIG_STM32_STM32F205 is not set
 # CONFIG_STM32_STM32F207 is not set
 # CONFIG_STM32_STM32F30XX is not set
+# CONFIG_STM32_STM32F37XX is not set
 # CONFIG_STM32_STM32F40XX is not set
 # CONFIG_STM32_STM32F401 is not set
 # CONFIG_STM32_STM32F411 is not set
@@ -230,7 +295,7 @@ CONFIG_STM32_MEDIUMDENSITY=y
 # CONFIG_STM32_HAVE_CCM is not set
 CONFIG_STM32_HAVE_USBDEV=y
 # CONFIG_STM32_HAVE_OTGFS is not set
-# CONFIG_STM32_HAVE_FSMC is not set
+CONFIG_STM32_HAVE_FSMC=y
 CONFIG_STM32_HAVE_USART3=y
 CONFIG_STM32_HAVE_UART4=y
 CONFIG_STM32_HAVE_UART5=y
@@ -273,6 +338,7 @@ CONFIG_STM32_DMA1=y
 # CONFIG_STM32_DMA2 is not set
 # CONFIG_STM32_DAC1 is not set
 # CONFIG_STM32_DAC2 is not set
+# CONFIG_STM32_FSMC is not set
 # CONFIG_STM32_I2C1 is not set
 # CONFIG_STM32_I2C2 is not set
 # CONFIG_STM32_PWR is not set
@@ -289,19 +355,22 @@ CONFIG_STM32_SPI2=y
 # CONFIG_STM32_TIM7 is not set
 # CONFIG_STM32_TIM8 is not set
 # CONFIG_STM32_USART1 is not set
-CONFIG_STM32_USART2=y
-# CONFIG_STM32_USART3 is not set
+# CONFIG_STM32_USART2 is not set
+CONFIG_STM32_USART3=y
 # CONFIG_STM32_UART4 is not set
 # CONFIG_STM32_UART5 is not set
 CONFIG_STM32_USB=y
 # CONFIG_STM32_IWDG is not set
 # CONFIG_STM32_WWDG is not set
 CONFIG_STM32_SPI=y
+# CONFIG_STM32_NOEXT_VECTORS is not set
 
 #
 # Alternate Pin Mapping
 #
-# CONFIG_STM32_USART2_REMAP is not set
+CONFIG_STM32_USART3_NO_REMAP=y
+# CONFIG_STM32_USART3_FULL_REMAP is not set
+# CONFIG_STM32_USART3_PARTIAL_REMAP is not set
 # CONFIG_STM32_JTAG_DISABLE is not set
 CONFIG_STM32_JTAG_FULL_ENABLE=y
 # CONFIG_STM32_JTAG_NOJNTRST_ENABLE is not set
@@ -315,8 +384,8 @@ CONFIG_STM32_USART=y
 #
 # U[S]ART Configuration
 #
-# CONFIG_USART2_RS485 is not set
-# CONFIG_USART2_RXDMA is not set
+# CONFIG_USART3_RS485 is not set
+# CONFIG_USART3_RXDMA is not set
 # CONFIG_SERIAL_DISABLE_REORDERING is not set
 # CONFIG_STM32_FLOWCONTROL_BROKEN is not set
 # CONFIG_STM32_USART_SINGLEWIRE is not set
@@ -326,6 +395,7 @@ CONFIG_STM32_USART=y
 #
 # CONFIG_STM32_SPI_INTERRUPTS is not set
 CONFIG_STM32_SPI_DMA=y
+CONFIG_STM32_HAVE_RTC_COUNTER=y
 # CONFIG_STM32_HAVE_RTC_SUBSECONDS is not set
 
 #
@@ -363,7 +433,6 @@ CONFIG_ARCH_HAVE_MPU=y
 # CONFIG_ARCH_USE_MPU is not set
 # CONFIG_ARCH_IRQPRIO is not set
 CONFIG_ARCH_STACKDUMP=y
-# CONFIG_ARCH_USBDUMP is not set
 # CONFIG_ENDIAN_BIG is not set
 # CONFIG_ARCH_IDLE_CUSTOM is not set
 # CONFIG_ARCH_HAVE_RAMFUNCS is not set
@@ -380,7 +449,7 @@ CONFIG_BOARD_LOOPSPERMSEC=5483
 # Interrupt options
 #
 CONFIG_ARCH_HAVE_INTERRUPTSTACK=y
-CONFIG_ARCH_INTERRUPTSTACK=156
+CONFIG_ARCH_INTERRUPTSTACK=512
 CONFIG_ARCH_HAVE_HIPRI_INTERRUPT=y
 # CONFIG_ARCH_HIPRI_INTERRUPT is not set
 
@@ -397,13 +466,12 @@ CONFIG_BOOT_RUNFROMFLASH=y
 # Boot Memory Configuration
 #
 CONFIG_RAM_START=0x20000000
-CONFIG_RAM_SIZE=20480
+CONFIG_RAM_SIZE=65536
 # CONFIG_ARCH_HAVE_SDRAM is not set
 
 #
 # Board Selection
 #
-# CONFIG_ARCH_BOARD_MAPLE is not set
 CONFIG_ARCH_BOARD_SPARK=y
 # CONFIG_ARCH_BOARD_CUSTOM is not set
 CONFIG_ARCH_BOARD="spark"
@@ -412,20 +480,22 @@ CONFIG_ARCH_BOARD="spark"
 # Common Board Options
 #
 CONFIG_ARCH_HAVE_LEDS=y
-CONFIG_ARCH_LEDS=y
+# CONFIG_ARCH_LEDS is not set
 CONFIG_ARCH_HAVE_BUTTONS=y
-CONFIG_ARCH_BUTTONS=y
+# CONFIG_ARCH_BUTTONS is not set
 CONFIG_ARCH_HAVE_IRQBUTTONS=y
-CONFIG_ARCH_IRQBUTTONS=y
 CONFIG_NSH_MMCSDMINOR=0
 
 #
 # Board-Specific Options
 #
-CONFIG_SPARK_FLASH=y
-CONFIG_SPARK_FLASH_SPI=2
-CONFIG_SPARK_FLASH_MINOR=0
-# CONFIG_SPARK_FLASH_PART is not set
+# CONFIG_SPARK_FLASH is not set
+CONFIG_LIB_BOARDCTL=y
+# CONFIG_BOARDCTL_TSCTEST is not set
+# CONFIG_BOARDCTL_ADCTEST is not set
+# CONFIG_BOARDCTL_PWMTEST is not set
+# CONFIG_BOARDCTL_GRAPHICS is not set
+# CONFIG_BOARDCTL_IOCTL is not set
 
 #
 # RTOS Features
@@ -517,10 +587,10 @@ CONFIG_MQ_MAXMSGSIZE=8
 #
 # Stack and heap information
 #
-CONFIG_IDLETHREAD_STACKSIZE=300
-CONFIG_USERMAIN_STACKSIZE=880
-CONFIG_PTHREAD_STACK_MIN=256
-CONFIG_PTHREAD_STACK_DEFAULT=464
+CONFIG_IDLETHREAD_STACKSIZE=512
+CONFIG_USERMAIN_STACKSIZE=2048
+CONFIG_PTHREAD_STACK_MIN=512
+CONFIG_PTHREAD_STACK_DEFAULT=2048
 # CONFIG_LIB_SYSCALL is not set
 
 #
@@ -544,16 +614,19 @@ CONFIG_ARCH_HAVE_I2CRESET=y
 # CONFIG_I2C is not set
 CONFIG_SPI=y
 # CONFIG_SPI_OWNBUS is not set
-CONFIG_SPI_EXCHANGE=y
+# CONFIG_SPI_EXCHANGE is not set
 # CONFIG_SPI_CMDDATA is not set
+# CONFIG_SPI_CALLBACK is not set
 # CONFIG_SPI_BITBANG is not set
 # CONFIG_I2S is not set
+
+#
+# Timer Driver Support
+#
 # CONFIG_TIMER is not set
 # CONFIG_RTC is not set
 # CONFIG_WATCHDOG is not set
-CONFIG_ANALOG=y
-# CONFIG_ADC is not set
-# CONFIG_DAC is not set
+# CONFIG_ANALOG is not set
 # CONFIG_AUDIO_DEVICES is not set
 # CONFIG_VIDEO_DEVICES is not set
 # CONFIG_BCH is not set
@@ -565,9 +638,9 @@ CONFIG_MTD=y
 #
 # MTD Configuration
 #
-CONFIG_MTD_PARTITION=y
+# CONFIG_MTD_PARTITION is not set
 # CONFIG_MTD_SECT512 is not set
-CONFIG_MTD_BYTE_WRITE=y
+# CONFIG_MTD_BYTE_WRITE is not set
 # CONFIG_MTD_CONFIG is not set
 
 #
@@ -581,16 +654,15 @@ CONFIG_MTD_BYTE_WRITE=y
 # CONFIG_MTD_M25P is not set
 # CONFIG_MTD_SMART is not set
 # CONFIG_MTD_RAMTRON is not set
-CONFIG_MTD_SST25=y
-CONFIG_SST25_SPIMODE=0
-CONFIG_SST25_SPIFREQUENCY=80000000
-# CONFIG_SST25_READONLY is not set
-CONFIG_SST25_SECTOR512=y
-# CONFIG_SST25_SLOWWRITE is not set
-# CONFIG_SST25_SLOWREAD is not set
+# CONFIG_MTD_SST25 is not set
 # CONFIG_MTD_SST25XX is not set
 # CONFIG_MTD_SST39FV is not set
-# CONFIG_MTD_W25 is not set
+CONFIG_MTD_W25=y
+CONFIG_W25_SPIMODE=0
+CONFIG_W25_SPIFREQUENCY=20000000
+# CONFIG_W25_READONLY is not set
+# CONFIG_W25_SECTOR512 is not set
+# CONFIG_W25_SLOWREAD is not set
 # CONFIG_EEPROM is not set
 # CONFIG_PIPES is not set
 # CONFIG_PM is not set
@@ -615,8 +687,8 @@ CONFIG_SERIAL_REMOVABLE=y
 # CONFIG_ARCH_HAVE_SCI1 is not set
 # CONFIG_ARCH_HAVE_USART0 is not set
 # CONFIG_ARCH_HAVE_USART1 is not set
-CONFIG_ARCH_HAVE_USART2=y
-# CONFIG_ARCH_HAVE_USART3 is not set
+# CONFIG_ARCH_HAVE_USART2 is not set
+CONFIG_ARCH_HAVE_USART3=y
 # CONFIG_ARCH_HAVE_USART4 is not set
 # CONFIG_ARCH_HAVE_USART5 is not set
 # CONFIG_ARCH_HAVE_USART6 is not set
@@ -627,28 +699,28 @@ CONFIG_ARCH_HAVE_USART2=y
 #
 # USART Configuration
 #
-CONFIG_USART2_ISUART=y
+CONFIG_USART3_ISUART=y
 CONFIG_MCU_SERIAL=y
 CONFIG_STANDARD_SERIAL=y
 # CONFIG_SERIAL_IFLOWCONTROL is not set
 # CONFIG_SERIAL_OFLOWCONTROL is not set
+# CONFIG_SERIAL_TIOCSERGSTRUCT is not set
 CONFIG_ARCH_HAVE_SERIAL_TERMIOS=y
-# CONFIG_SERIAL_TERMIOS is not set
-CONFIG_USART2_SERIAL_CONSOLE=y
+CONFIG_USART3_SERIAL_CONSOLE=y
 # CONFIG_OTHER_SERIAL_CONSOLE is not set
 # CONFIG_NO_SERIAL_CONSOLE is not set
 
 #
-# USART2 Configuration
+# USART3 Configuration
 #
-CONFIG_USART2_RXBUFSIZE=32
-CONFIG_USART2_TXBUFSIZE=32
-CONFIG_USART2_BAUD=115200
-CONFIG_USART2_BITS=8
-CONFIG_USART2_PARITY=0
-CONFIG_USART2_2STOP=0
-# CONFIG_USART2_IFLOWCONTROL is not set
-# CONFIG_USART2_OFLOWCONTROL is not set
+CONFIG_USART3_RXBUFSIZE=256
+CONFIG_USART3_TXBUFSIZE=256
+CONFIG_USART3_BAUD=115200
+CONFIG_USART3_BITS=8
+CONFIG_USART3_PARITY=0
+CONFIG_USART3_2STOP=0
+# CONFIG_USART3_IFLOWCONTROL is not set
+# CONFIG_USART3_OFLOWCONTROL is not set
 CONFIG_USBDEV=y
 
 #
@@ -661,9 +733,7 @@ CONFIG_USBDEV_SELFPOWERED=y
 CONFIG_USBDEV_MAXPOWER=100
 # CONFIG_USBDEV_DMA is not set
 # CONFIG_ARCH_USBDEV_STALLQUEUE is not set
-CONFIG_USBDEV_TRACE=y
-CONFIG_USBDEV_TRACE_NRECORDS=32
-# CONFIG_USBDEV_TRACE_STRINGS is not set
+# CONFIG_USBDEV_TRACE is not set
 
 #
 # USB Device Class Driver Options
@@ -673,7 +743,7 @@ CONFIG_COMPOSITE_IAD=y
 CONFIG_COMPOSITE_EP0MAXPACKET=64
 CONFIG_COMPOSITE_VENDORID=0x03eb
 CONFIG_COMPOSITE_VENDORSTR="NuttX"
-CONFIG_COMPOSITE_PRODUCTID=0x0000
+CONFIG_COMPOSITE_PRODUCTID=0x2022
 CONFIG_COMPOSITE_PRODUCTSTR="Composite device"
 CONFIG_COMPOSITE_SERIALSTR="001"
 CONFIG_COMPOSITE_CONFIGSTR="NuttX COMPOSITE config"
@@ -683,22 +753,22 @@ CONFIG_CDCACM=y
 # CONFIG_CDCACM_CONSOLE is not set
 CONFIG_CDCACM_COMPOSITE=y
 CONFIG_CDCACM_IFNOBASE=0
-CONFIG_CDCACM_STRBASE=0
+CONFIG_CDCACM_STRBASE=4
 CONFIG_CDCACM_EP0MAXPACKET=64
 CONFIG_CDCACM_EPINTIN=1
 CONFIG_CDCACM_EPINTIN_FSSIZE=64
 CONFIG_CDCACM_EPINTIN_HSSIZE=64
 CONFIG_CDCACM_EPBULKOUT=3
 CONFIG_CDCACM_EPBULKOUT_FSSIZE=64
-CONFIG_CDCACM_EPBULKOUT_HSSIZE=512
+CONFIG_CDCACM_EPBULKOUT_HSSIZE=64
 CONFIG_CDCACM_EPBULKIN=2
 CONFIG_CDCACM_EPBULKIN_FSSIZE=64
-CONFIG_CDCACM_EPBULKIN_HSSIZE=512
-CONFIG_CDCACM_NWRREQS=4
-CONFIG_CDCACM_NRDREQS=4
-CONFIG_CDCACM_BULKIN_REQLEN=100
-CONFIG_CDCACM_RXBUFSIZE=100
-CONFIG_CDCACM_TXBUFSIZE=80
+CONFIG_CDCACM_EPBULKIN_HSSIZE=64
+CONFIG_CDCACM_NWRREQS=2
+CONFIG_CDCACM_NRDREQS=2
+CONFIG_CDCACM_BULKIN_REQLEN=96
+CONFIG_CDCACM_RXBUFSIZE=256
+CONFIG_CDCACM_TXBUFSIZE=256
 CONFIG_CDCACM_VENDORID=0x0525
 CONFIG_CDCACM_PRODUCTID=0xa4a7
 CONFIG_CDCACM_VENDORSTR="NuttX"
@@ -706,36 +776,24 @@ CONFIG_CDCACM_PRODUCTSTR="CDC/ACM Serial
 CONFIG_USBMSC=y
 CONFIG_USBMSC_COMPOSITE=y
 CONFIG_USBMSC_IFNOBASE=2
-CONFIG_USBMSC_STRBASE=2
+CONFIG_USBMSC_STRBASE=4
 CONFIG_USBMSC_EP0MAXPACKET=64
-CONFIG_USBMSC_EPBULKOUT=2
-CONFIG_USBMSC_EPBULKIN=3
-CONFIG_USBMSC_NWRREQS=4
-CONFIG_USBMSC_NRDREQS=4
-CONFIG_USBMSC_BULKINREQLEN=256
-CONFIG_USBMSC_BULKOUTREQLEN=256
+CONFIG_USBMSC_EPBULKOUT=4
+CONFIG_USBMSC_EPBULKIN=5
+CONFIG_USBMSC_NWRREQS=2
+CONFIG_USBMSC_NRDREQS=2
+CONFIG_USBMSC_BULKINREQLEN=64
+CONFIG_USBMSC_BULKOUTREQLEN=64
 CONFIG_USBMSC_VENDORID=0x584e
-CONFIG_USBMSC_VENDORSTR="NuttX"
-CONFIG_USBMSC_PRODUCTID=0x5342
+CONFIG_USBMSC_VENDORSTR="UtopiaTeam"
+CONFIG_USBMSC_PRODUCTID=0x0001
 CONFIG_USBMSC_PRODUCTSTR="Mass Storage"
-CONFIG_USBMSC_VERSIONNO=0x399
-# CONFIG_USBMSC_REMOVABLE is not set
+CONFIG_USBMSC_VERSIONNO=0x0000
+CONFIG_USBMSC_REMOVABLE=y
 CONFIG_USBMSC_SCSI_PRIO=128
-CONFIG_USBMSC_SCSI_STACKSIZE=464
+CONFIG_USBMSC_SCSI_STACKSIZE=2048
 # CONFIG_USBHOST is not set
-CONFIG_WIRELESS=y
-# CONFIG_WL_CC1101 is not set
-CONFIG_WL_CC3000=y
-# CONFIG_CC3000_MULTIPLE is not set
-CONFIG_CC3000_SPIDEV=2
-CONFIG_CC3000_DEVMINOR=0
-CONFIG_CC3000_SPI_MODE=1
-CONFIG_CC3000_SPI_FREQUENCY=16000000
-CONFIG_CC3000_WORKER_STACKSIZE=240
-CONFIG_CC3000_SELECT_STACKSIZE=368
-CONFIG_CC3000_UNSOLICED_STACKSIZE=264
-# CONFIG_CC3000_PROBES is not set
-# CONFIG_WL_NRF24L01 is not set
+# CONFIG_WIRELESS is not set
 
 #
 # System Logging Device Options
@@ -750,7 +808,7 @@ CONFIG_CC3000_UNSOLICED_STACKSIZE=264
 #
 # Networking Support
 #
-CONFIG_ARCH_HAVE_NET=y
+# CONFIG_ARCH_HAVE_NET is not set
 # CONFIG_ARCH_HAVE_PHY is not set
 # CONFIG_NET is not set
 
@@ -786,6 +844,7 @@ CONFIG_FS_FATTIME=y
 # CONFIG_FS_SMARTFS is not set
 # CONFIG_FS_BINFS is not set
 # CONFIG_FS_PROCFS is not set
+# CONFIG_FS_UNIONFS is not set
 
 #
 # System Logging
@@ -852,6 +911,7 @@ CONFIG_LIBC_TMPDIR="/tmp"
 CONFIG_LIBC_MAX_TMPFILE=32
 CONFIG_ARCH_LOWPUTC=y
 # CONFIG_LIBC_LOCALTIME is not set
+# CONFIG_TIME_EXTENDED is not set
 CONFIG_LIB_SENDFILE_BUFSIZE=0
 # CONFIG_ARCH_ROMGETC is not set
 # CONFIG_ARCH_OPTIMIZED_FUNCTIONS is not set
@@ -882,9 +942,6 @@ CONFIG_BUILTIN_PROXY_STACKSIZE=1024
 #
 # CONFIG_EXAMPLES_BUTTONS is not set
 # CONFIG_EXAMPLES_CAN is not set
-CONFIG_EXAMPLES_CC3000BASIC=y
-# CONFIG_EXAMPLES_CC3000_MEM_CHECK is not set
-# CONFIG_EXAMPLES_CC3000_STACK_CHECK is not set
 # CONFIG_EXAMPLES_CONFIGDATA is not set
 # CONFIG_EXAMPLES_CPUHOG is not set
 # CONFIG_EXAMPLES_DHCPD is not set
@@ -900,24 +957,22 @@ CONFIG_EXAMPLES_CC3000BASIC=y
 # CONFIG_EXAMPLES_MM is not set
 # CONFIG_EXAMPLES_MODBUS is not set
 # CONFIG_EXAMPLES_MOUNT is not set
-# CONFIG_EXAMPLES_MTDPART is not set
 # CONFIG_EXAMPLES_NRF24L01TERM is not set
 CONFIG_EXAMPLES_NSH=y
 # CONFIG_EXAMPLES_NULL is not set
 # CONFIG_EXAMPLES_NX is not set
 # CONFIG_EXAMPLES_NXTERM is not set
 # CONFIG_EXAMPLES_NXFFS is not set
-# CONFIG_EXAMPLES_NXFLAT is not set
 # CONFIG_EXAMPLES_NXHELLO is not set
 # CONFIG_EXAMPLES_NXIMAGE is not set
 # CONFIG_EXAMPLES_NXLINES is not set
 # CONFIG_EXAMPLES_NXTEXT is not set
 # CONFIG_EXAMPLES_OSTEST is not set
 # CONFIG_EXAMPLES_PIPE is not set
+# CONFIG_EXAMPLES_PPPD is not set
 # CONFIG_EXAMPLES_POSIXSPAWN is not set
 # CONFIG_EXAMPLES_QENCODER is not set
 # CONFIG_EXAMPLES_RGMP is not set
-# CONFIG_EXAMPLES_ROMFS is not set
 # CONFIG_EXAMPLES_SENDMAIL is not set
 # CONFIG_EXAMPLES_SERIALBLASTER is not set
 # CONFIG_EXAMPLES_SERIALRX is not set
@@ -927,7 +982,6 @@ CONFIG_EXAMPLES_NSH=y
 # CONFIG_EXAMPLES_SMART is not set
 # CONFIG_EXAMPLES_TCPECHO is not set
 # CONFIG_EXAMPLES_TELNETD is not set
-# CONFIG_EXAMPLES_THTTPD is not set
 # CONFIG_EXAMPLES_TIFF is not set
 # CONFIG_EXAMPLES_TOUCHSCREEN is not set
 # CONFIG_EXAMPLES_WEBSERVER is not set
@@ -960,10 +1014,6 @@ CONFIG_EXAMPLES_NSH=y
 # CONFIG_NETUTILS_FTPC is not set
 # CONFIG_NETUTILS_JSON is not set
 # CONFIG_NETUTILS_SMTP is not set
-# CONFIG_NETUTILS_TFTPC is not set
-# CONFIG_NETUTILS_THTTPD is not set
-# CONFIG_NETUTILS_NETLIB is not set
-# CONFIG_NETUTILS_WEBCLIENT is not set
 
 #
 # FreeModBus
@@ -997,6 +1047,7 @@ CONFIG_NSH_BUILTIN_APPS=y
 # CONFIG_NSH_DISABLE_CD is not set
 # CONFIG_NSH_DISABLE_CP is not set
 # CONFIG_NSH_DISABLE_CMP is not set
+CONFIG_NSH_DISABLE_DATE=y
 # CONFIG_NSH_DISABLE_DD is not set
 CONFIG_NSH_DISABLE_DF=y
 # CONFIG_NSH_DISABLE_DELROUTE is not set
@@ -1018,6 +1069,7 @@ CONFIG_NSH_DISABLE_DF=y
 # CONFIG_NSH_DISABLE_MKRD is not set
 # CONFIG_NSH_DISABLE_MH is not set
 # CONFIG_NSH_DISABLE_MOUNT is not set
+# CONFIG_NSH_DISABLE_MV is not set
 # CONFIG_NSH_DISABLE_MW is not set
 # CONFIG_NSH_DISABLE_PS is not set
 # CONFIG_NSH_DISABLE_PUT is not set
@@ -1052,15 +1104,15 @@ CONFIG_NSH_DISABLE_LOOPS=y
 # Console Configuration
 #
 CONFIG_NSH_CONSOLE=y
-# CONFIG_NSH_USBCONSOLE is not set
-# CONFIG_NSH_ALTCONDEV is not set
+CONFIG_NSH_USBCONSOLE=y
+CONFIG_NSH_USBCONDEV="/dev/ttyACM0"
+CONFIG_USBDEV_MINOR=0
 
 #
 # USB Device Trace Support
 #
 # CONFIG_NSH_USBDEV_TRACE is not set
 CONFIG_NSH_ARCHINIT=y
-CONFIG_LIB_BOARDCTL=y
 
 #
 # NxWidgets/NxWM
@@ -1074,129 +1126,34 @@ CONFIG_LIB_BOARDCTL=y
 #
 # System Libraries and NSH Add-Ons
 #
-
-#
-# Custom Free Memory Command
-#
-# CONFIG_SYSTEM_FREE is not set
-
-#
-# EMACS-like Command Line Editor
-#
+CONFIG_SYSTEM_FREE=y
 # CONFIG_SYSTEM_CLE is not set
-
-#
-# CU Minimal Terminal
-#
 # CONFIG_SYSTEM_CUTERM is not set
-
-#
-# FLASH Program Installation
-#
 # CONFIG_SYSTEM_INSTALL is not set
-
-#
-# FLASH Erase-all Command
-#
 # CONFIG_SYSTEM_FLASH_ERASEALL is not set
-
-#
-# Intel HEX to binary conversion
-#
 # CONFIG_SYSTEM_HEX2BIN is not set
-
-#
-# I2C tool
-#
-
-#
-# INI File Parser
-#
 # CONFIG_SYSTEM_INIFILE is not set
-
-#
-# NxPlayer media player library / command Line
-#
-
-#
-# RAM test
-#
 # CONFIG_SYSTEM_RAMTEST is not set
-
-#
-# readline()
-#
 CONFIG_SYSTEM_READLINE=y
 CONFIG_READLINE_ECHO=y
-
-#
-# P-Code Support
-#
-
-#
-# PHY Tool
-#
-
-#
-# Power Off
-#
 # CONFIG_SYSTEM_POWEROFF is not set
-
-#
-# RAMTRON
-#
 # CONFIG_SYSTEM_RAMTRON is not set
-
-#
-# SD Card
-#
 # CONFIG_SYSTEM_SDCARD is not set
-
-#
-# Sudoku
-#
 # CONFIG_SYSTEM_SUDOKU is not set
-
-#
-# Sysinfo
-#
-CONFIG_SYSTEM_SYSINFO=y
-CONFIG_SYSTEM_SYSINFO_STACKSIZE=1024
-
-#
-# Temperature
-#
-
-#
-# VI Work-Alike Editor
-#
+# CONFIG_SYSTEM_SYSINFO is not set
 # CONFIG_SYSTEM_VI is not set
-
-#
-# Stack Monitor
-#
-
-#
-# USB CDC/ACM Device Commands
-#
 # CONFIG_SYSTEM_CDCACM is not set
-
-#
-# USB Composite Device Commands
-#
-# CONFIG_SYSTEM_COMPOSITE is not set
-
-#
-# USB Mass Storage Device Commands
-#
+CONFIG_SYSTEM_COMPOSITE=y
+CONFIG_SYSTEM_COMPOSITE_NLUNS=1
+CONFIG_SYSTEM_COMPOSITE_DEVMINOR1=0
+CONFIG_SYSTEM_COMPOSITE_DEVPATH1="/dev/mtdblock0"
+CONFIG_SYSTEM_COMPOSITE_DEVMINOR2=1
+CONFIG_SYSTEM_COMPOSITE_DEVPATH2="/dev/mmcsd1"
+CONFIG_SYSTEM_COMPOSITE_DEVMINOR3=2
+CONFIG_SYSTEM_COMPOSITE_DEVPATH3="/dev/mmcsd2"
+CONFIG_SYSTEM_COMPOSITE_TTYUSB=0
+CONFIG_SYSTEM_COMPOSITE_SERDEV="/dev/ttyACM0"
+CONFIG_SYSTEM_COMPOSITE_BUFSIZE=256
+# CONFIG_SYSTEM_COMPOSITE_DEBUGMM is not set
 # CONFIG_SYSTEM_USBMSC is not set
-
-#
-# USB Monitor
-#
-# CONFIG_SYSTEM_USBMONITOR is not set
-
-#
-# Zmodem Commands
-#
 # CONFIG_SYSTEM_ZMODEM is not set
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/spark/scripts/ld.script src/nuttx/configs/spark/scripts/ld.script
--- tmp/nuttx/configs/spark/scripts/ld.script	2015-06-10 21:03:49.133512463 +0300
+++ src/nuttx/configs/spark/scripts/ld.script	2015-07-01 22:13:52.010529848 +0300
@@ -43,8 +43,8 @@
 
 MEMORY
 {
-    flash (rx) : ORIGIN = 0x08000000, LENGTH = 128K
-    sram (rwx) : ORIGIN = 0x20000000, LENGTH = 20K
+    flash (rx) : ORIGIN = 0x08000000, LENGTH = 256K
+    sram (rwx) : ORIGIN = 0x20000000, LENGTH = 64K
 }
 
 OUTPUT_ARCH(arm)
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/spark/src/spark.h src/nuttx/configs/spark/src/spark.h
--- tmp/nuttx/configs/spark/src/spark.h	2015-06-10 21:03:49.133512463 +0300
+++ src/nuttx/configs/spark/src/spark.h	2015-07-01 22:49:08.522481453 +0300
@@ -180,7 +180,7 @@
 #define GPIO_LED3     (GPIO_PORTA | GPIO_PIN9  | GPIO_OUTPUT_CLEAR | GPIO_OUTPUT | GPIO_CNF_OUTPP | GPIO_MODE_50MHz)
 #define GPIO_LED4     (GPIO_PORTA | GPIO_PIN10 | GPIO_OUTPUT_SET   | GPIO_OUTPUT | GPIO_CNF_OUTPP | GPIO_MODE_50MHz)
 
-#define GPIO_USB_PULLUP (GPIO_PORTB | GPIO_PIN10 | GPIO_OUTPUT_SET | GPIO_OUTPUT | GPIO_CNF_OUTPP | GPIO_MODE_50MHz)
+#define GPIO_USB_PULLUP (GPIO_PORTA | GPIO_PIN10 | GPIO_OUTPUT_SET | GPIO_OUTPUT | GPIO_CNF_OUTPP | GPIO_MODE_50MHz)
 
 /* BUTTON ***************************************************************************/
 /*
@@ -202,7 +202,9 @@
  *  PB[09] TIM4_CH4                                          46       MEM_CS                 DISC
 */
 
-#define GPIO_MEM_CS   (GPIO_PORTB | GPIO_PIN9 |  GPIO_OUTPUT_SET   | GPIO_OUTPUT | GPIO_CNF_OUTPP | GPIO_MODE_50MHz)
+#define GPIO_MEM_CS   (GPIO_PORTB | GPIO_PIN12 |  GPIO_OUTPUT_SET   | GPIO_OUTPUT | GPIO_CNF_OUTPP | GPIO_MODE_50MHz)
+#define GPIO_MEM_WP   (GPIO_PORTC | GPIO_PIN8  |  GPIO_OUTPUT_SET   | GPIO_OUTPUT | GPIO_CNF_OUTPP | GPIO_MODE_50MHz)
+#define GPIO_MEM_HOLD (GPIO_PORTC | GPIO_PIN9  |  GPIO_OUTPUT_SET   | GPIO_OUTPUT | GPIO_CNF_OUTPP | GPIO_MODE_50MHz)
 
 /* CCS3000 **************************************************************************/
 /*
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/spark/src/stm32_nsh.c src/nuttx/configs/spark/src/stm32_nsh.c
--- tmp/nuttx/configs/spark/src/stm32_nsh.c	2015-06-12 14:17:28.250391796 +0300
+++ src/nuttx/configs/spark/src/stm32_nsh.c	2015-07-26 11:47:27.543578190 +0300
@@ -65,6 +65,8 @@
 #include "stm32.h"
 #include "spark.h"
 
+#include <nuttx/usb/composite.h>
+
 /****************************************************************************
  * Pre-processor Definitions
  ****************************************************************************/
@@ -134,6 +136,7 @@
 
 int board_app_initialize(void)
 {
+#if 0
 #ifdef HAVE_SST25
   FAR struct spi_dev_s *spi;
   FAR struct mtd_dev_s *mtd;
@@ -282,6 +285,32 @@ int board_app_initialize(void)
     }
 #endif
 
+#else /* #if 0 */
+
+  FAR struct spi_dev_s *spi;
+  FAR struct mtd_dev_s *mtd;
+  int ret;
+
+  spi = up_spiinitialize(2);
+  if (spi == NULL)
+    {
+      return -1;
+    }
+
+  mtd = w25_initialize(spi);
+  if (!mtd)
+    {
+      return -1;
+    }
+
+  ret = ftl_initialize(0, mtd);
+  if (ret < 0)
+    {
+      return -1;
+    }
+
+#endif /* #else */
+
   return OK;
 }
 
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/spark/src/stm32_spi.c src/nuttx/configs/spark/src/stm32_spi.c
--- tmp/nuttx/configs/spark/src/stm32_spi.c	2015-06-10 21:03:49.133512463 +0300
+++ src/nuttx/configs/spark/src/stm32_spi.c	2015-07-01 22:13:52.010529848 +0300
@@ -109,8 +109,10 @@ void weak_function stm32_spiinitialize(v
   stm32_configgpio(GPIO_WIFI_INT);
 #endif
 
-#ifdef CONFIG_MTD_SST25
+#ifdef CONFIG_MTD_W25
   stm32_configgpio(GPIO_MEM_CS);    /* FLASH chip select */
+  stm32_configgpio(GPIO_MEM_WP);    /* FLASH write protect */
+  stm32_configgpio(GPIO_MEM_HOLD);  /* FLASH hold */
 #endif
 
 #endif
@@ -158,7 +160,7 @@ void stm32_spi2select(FAR struct spi_dev
 {
   spidbg("devid: %d CS: %s\n", (int)devid, selected ? "assert" : "de-assert");
 
-#if defined(CONFIG_MTD_SST25)
+#if defined(CONFIG_MTD_W25)
 
   if (devid == SPIDEV_FLASH)
     {
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/configs/spark/src/stm32_usbdev.c src/nuttx/configs/spark/src/stm32_usbdev.c
--- tmp/nuttx/configs/spark/src/stm32_usbdev.c	2015-06-10 21:03:49.133512463 +0300
+++ src/nuttx/configs/spark/src/stm32_usbdev.c	2015-07-01 22:49:30.714480946 +0300
@@ -96,7 +96,7 @@ void stm32_usbinitialize(void)
 int stm32_usbpullup(FAR struct usbdev_s *dev, bool enable)
 {
   usbtrace(TRACE_DEVPULLUP, (uint16_t)enable);
-  stm32_gpiowrite(GPIO_USB_PULLUP, !enable);
+  stm32_gpiowrite(GPIO_USB_PULLUP, enable);
   return OK;
 }
 
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/drivers/usbdev/cdcacm.c src/nuttx/drivers/usbdev/cdcacm.c
--- tmp/nuttx/drivers/usbdev/cdcacm.c	2015-06-10 21:03:49.241512464 +0300
+++ src/nuttx/drivers/usbdev/cdcacm.c	2015-07-26 12:30:38.151518955 +0300
@@ -2388,7 +2388,7 @@ errout_with_class:
  *
  ****************************************************************************/
 
-#ifndef CONFIG_CDCACM_COMPOSITE
+//#ifndef CONFIG_CDCACM_COMPOSITE
 int cdcacm_initialize(int minor, FAR void **handle)
 {
   FAR struct usbdevclass_driver_s *drvr = NULL;
@@ -2397,11 +2397,13 @@ int cdcacm_initialize(int minor, FAR voi
   /* Get an instance of the serial driver class object */
 
   ret = cdcacm_classobject(minor, &drvr);
+  lowsyslog(0, "cdcacm_classobject ret=%d\n", ret);
   if (ret == OK)
     {
       /* Register the USB serial class driver */
 
       ret = usbdev_register(drvr);
+      lowsyslog(0, "usbdev_register ret=%d\n", ret);
       if (ret < 0)
         {
           usbtrace(TRACE_CLSERROR(USBSER_TRACEERR_DEVREGISTER), (uint16_t)-ret);
@@ -2419,7 +2421,7 @@ int cdcacm_initialize(int minor, FAR voi
 
   return ret;
 }
-#endif
+//#endif
 
 /****************************************************************************
  * Name: cdcacm_uninitialize
diff -Nurp -x '*~' -x '*.orig' tmp/nuttx/.version src/nuttx/.version
--- tmp/nuttx/.version	1970-01-01 03:00:00.000000000 +0300
+++ src/nuttx/.version	2015-07-01 22:13:52.010529848 +0300
@@ -0,0 +1,6 @@
+#!/bin/bash
+
+CONFIG_VERSION_STRING="0.0"
+CONFIG_VERSION_MAJOR=0
+CONFIG_VERSION_MINOR=0
+CONFIG_VERSION_BUILD="0"
